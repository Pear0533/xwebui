[{"id":"veo_2_video_generation","user_id":"1253ad24-54ec-4e73-9892-1b7fa1e5a06a","name":"Generate Video","content":"import unittest\nimport asyncio\nimport re\nfrom typing import Any, Callable, Optional\nimport requests\nimport json\nfrom pydantic import BaseModel, Field\n\n\nclass EventEmitter:\n    def __init__(self, event_emitter: Callable[[dict], Any] = None):\n        self.event_emitter = event_emitter\n\n    async def progress_update(self, description):\n        await self.emit(description)\n\n    async def error_update(self, description):\n        await self.emit(description, \"error\", True)\n\n    async def success_update(self, description):\n        await self.emit(description, \"success\", True)\n\n    async def emit(self, description=\"Unknown State\", status=\"in_progress\", done=False):\n        if self.event_emitter:\n            await self.event_emitter(\n                {\n                    \"type\": \"status\",\n                    \"data\": {\n                        \"status\": status,\n                        \"description\": description,\n                        \"done\": done,\n                    },\n                }\n            )\n\n\nclass Tools:\n    class Valves(BaseModel):\n        GOOGLE_API_KEY: str = Field(\n            default=\"\", description=\"Google API key for accessing the Veo API.\"\n        )\n        BASE_URL: str = Field(\n            default=\"https://generativelanguage.googleapis.com/v1beta\",\n            description=\"Base URL for the Google Veo API.\",\n        )\n        PROXY_URL: str = Field(\n            default=\"https://ai-asset-proxy.mrproper.dev/api/gemini/veo\",\n            description=\"Proxy URL for serving Veo videos.\",\n        )\n        CITATION: bool = Field(\n            default=True, description=\"Whether to include citations in the response.\"\n        )\n\n    def __init__(self):\n        self.valves = self.Valves()\n        self.citation = self.valves.CITATION\n\n    def _extract_video_id(self, uri: str) -> str:\n        \"\"\"Extract the video ID from a Google Veo video URI.\"\"\"\n        # Format: https://generativelanguage.googleapis.com/v1beta/files/[VIDEO_ID]:download?alt=media\n        match = re.search(r\"files/([a-zA-Z0-9]+)(?::download)?\", uri)\n        if match:\n            return match.group(1)\n        return None\n\n    def _create_proxy_url(self, video_id: str, api_key: str) -> str:\n        \"\"\"Create a proxy URL for the video using the specified format.\"\"\"\n        if not video_id:\n            return None\n        return f\"{self.valves.PROXY_URL}/{video_id}/{api_key}\"\n\n    async def generate_video(\n        self,\n        prompt: str,\n        aspect_ratio: str = \"16:9\",\n        negative_prompt: Optional[str] = None,\n        person_generation: str = \"allow_adult\",\n        number_of_videos: int = 1,\n        duration_seconds: int = 8,\n        enhance_prompt: bool = True,\n        image: Optional[str] = None,\n        __event_emitter__: Callable[[dict], Any] = None,\n    ) -> str:\n        \"\"\"\n        Generates a video using Google's Veo API based on a text prompt or image.\n\n        :param prompt: Text description of the video content you want to generate. Optional if image is provided.\n        :param aspect_ratio: The aspect ratio of the video. Supported values are \"16:9\" and \"9:16\". Default is \"16:9\".\n        :param negative_prompt: Text string that describes anything you want to discourage the model from generating.\n        :param person_generation: Controls generation of people in videos. Options:\n            - \"dont_allow\": Don't allow the inclusion of people or faces\n            - \"allow_adult\": Generate videos that include adults, but not children\n            - \"allow_all\": Generate videos that include adults and children\n        :param number_of_videos: Output videos requested, either 1 or 2.\n        :param duration_seconds: Length of each output video in seconds, between 5 and 8.\n        :param enhance_prompt: Enable or disable the prompt rewriter. Enabled by default.\n        :param image: The image to use as the first frame for the video. Optional if prompt is provided.\n        :return: A plain text response with the prompt and video URLs in <video> tags.\n        \"\"\"\n        emitter = EventEmitter(__event_emitter__)\n\n        try:\n            # Validate input parameters\n            if not prompt and not image:\n                raise Exception(\"Either prompt or image must be provided\")\n\n            # Check if API key is provided\n            if not self.valves.GOOGLE_API_KEY:\n                raise Exception(\n                    \"No Google API key provided. Please set a Google API key in tool valves to use this tool.\"\n                )\n\n            # Validate person_generation parameter\n            valid_person_options = [\"dont_allow\", \"allow_adult\", \"allow_all\"]\n            if person_generation not in valid_person_options:\n                raise Exception(\n                    f\"Invalid person_generation option: {person_generation}. Must be one of: {', '.join(valid_person_options)}\"\n                )\n\n            # Validate number_of_videos parameter\n            if number_of_videos not in [1, 2]:\n                raise Exception(\n                    f\"Invalid number_of_videos: {number_of_videos}. Must be either 1 or 2.\"\n                )\n\n            # Validate duration_seconds parameter\n            if duration_seconds < 5 or duration_seconds > 8:\n                raise Exception(\n                    f\"Invalid duration_seconds: {duration_seconds}. Must be between 5 and 8 seconds.\"\n                )\n\n            # Validate aspect_ratio parameter\n            valid_aspect_ratios = [\"16:9\", \"9:16\"]\n            if aspect_ratio not in valid_aspect_ratios:\n                raise Exception(\n                    f\"Invalid aspect_ratio: {aspect_ratio}. Must be one of: {', '.join(valid_aspect_ratios)}\"\n                )\n\n            # Prepare the API request\n            if prompt:\n                await emitter.progress_update(\n                    f\"Preparing video generation for prompt: '{prompt}'\"\n                )\n            else:\n                await emitter.progress_update(\n                    \"Preparing video generation from image input\"\n                )\n\n            base_url = self.valves.BASE_URL\n            headers = {\"Content-Type\": \"application/json\"}\n\n            # Create the instance part of the request\n            instance = {}\n            if prompt:\n                instance[\"prompt\"] = prompt\n            if image:\n                instance[\"image\"] = image\n\n            # Create the parameters section\n            parameters = {\n                \"aspectRatio\": aspect_ratio,\n                \"personGeneration\": person_generation,\n                \"sampleCount\": number_of_videos,\n                \"durationSeconds\": duration_seconds,\n            }\n\n            # Add negative prompt if provided\n            if negative_prompt:\n                parameters[\"negativePrompt\"] = negative_prompt\n\n            # Create the complete request payload\n            data = {\"instances\": [instance], \"parameters\": parameters}\n\n            # Make the API request to initiate video generation\n            await emitter.progress_update(\"Initiating video generation process\")\n            url = f\"{base_url}/models/veo-2.0-generate-001:predictLongRunning?key={self.valves.GOOGLE_API_KEY}\"\n\n            response = requests.post(url, headers=headers, json=data)\n\n            # Check if the request was successful\n            if response.status_code != 200:\n                error_info = response.text\n                raise Exception(\n                    f\"API request failed with status code: {response.status_code}. Details: {error_info}\"\n                )\n\n            # Parse the response to get the operation name\n            response_data = response.json()\n            operation_name = response_data.get(\"name\")\n\n            if not operation_name:\n                raise Exception(\"Failed to get operation name from API response\")\n\n            await emitter.progress_update(\n                f\"Video generation initiated. Operation name: {operation_name}\"\n            )\n\n            # Poll for completion\n            await emitter.progress_update(\n                \"Waiting for video generation to complete (this may take several minutes)\"\n            )\n\n            complete = False\n            max_retries = 60  # Maximum number of retries\n            retry_count = 0\n\n            while not complete and retry_count < max_retries:\n                check_url = (\n                    f\"{base_url}/{operation_name}?key={self.valves.GOOGLE_API_KEY}\"\n                )\n                check_response = requests.get(check_url)\n\n                if check_response.status_code != 200:\n                    raise Exception(\n                        f\"Failed to check operation status: {check_response.status_code}\"\n                    )\n\n                status_data = check_response.json()\n                is_done = status_data.get(\"done\", False)\n\n                if is_done:\n                    complete = True\n                    await emitter.progress_update(\"Video generation complete!\")\n\n                    # Check for errors\n                    if \"error\" in status_data:\n                        error_details = status_data.get(\"error\", {})\n                        error_message = error_details.get(\"message\", \"Unknown error\")\n                        raise Exception(f\"Video generation failed: {error_message}\")\n\n                    # Format the response with video URLs in <video> tags using the proxy\n                    video_urls = []\n                    if (\n                        \"response\" in status_data\n                        and \"generateVideoResponse\" in status_data[\"response\"]\n                    ):\n                        gen_response = status_data[\"response\"][\"generateVideoResponse\"]\n                        if \"generatedSamples\" in gen_response:\n                            samples = gen_response[\"generatedSamples\"]\n                            for sample in samples:\n                                if \"video\" in sample and \"uri\" in sample[\"video\"]:\n                                    uri = sample[\"video\"][\"uri\"]\n                                    # Extract video ID and create proxy URL\n                                    video_id = self._extract_video_id(uri)\n                                    if video_id:\n                                        proxy_url = self._create_proxy_url(\n                                            video_id, self.valves.GOOGLE_API_KEY\n                                        )\n                                        await __event_emitter__(\n                                            {\n                                                \"type\": \"message\",\n                                                \"data\": {\n                                                    \"content\": f\"<video>\\n{proxy_url}\\n</video>\\n\\n\"\n                                                },\n                                            }\n                                        )\n                                        video_urls.append(proxy_url)\n\n                    # Create the response text with prompt and video tags\n                    if video_urls:\n                        # Start with LLM instructions and prompt announcement\n                        response_text = (\n                            f\"Video has been generated with prompt: {prompt}\"\n                        )\n\n                        await emitter.success_update(\n                            \"Video generation successful! Videos are ready to view.\"\n                        )\n                        return response_text.strip()\n                    else:\n                        raise Exception(\n                            f\"No video URLs found in the response. {status_data}\"\n                        )\n                else:\n                    retry_count += 1\n                    await emitter.progress_update(\n                        f\"Video still generating... (check {retry_count}/{max_retries})\"\n                    )\n                    await asyncio.sleep(5)  # Wait for 5 seconds before checking again\n\n            if not complete:\n                raise Exception(\n                    \"Video generation timed out. The process may still be running. Check the operation URL later.\"\n                )\n\n        except Exception as e:\n            error_message = f\"Error: {str(e)}\"\n            if \"401\" in str(e) or \"403\" in str(e):\n                error_message += \" (API key issue. Please check your Google API key.)\"\n            await emitter.error_update(error_message)\n            return error_message\n\n    async def check_video_status(\n        self,\n        operation_name: str,\n        __event_emitter__: Callable[[dict], Any] = None,\n    ) -> str:\n        \"\"\"\n        Check the status of a video generation operation.\n\n        :param operation_name: The operation name returned by the generate_video method.\n        :return: A plain text response with the video URLs in <video> tags if the operation is complete.\n        \"\"\"\n        emitter = EventEmitter(__event_emitter__)\n\n        try:\n            await emitter.progress_update(\n                f\"Checking status for operation: {operation_name}\"\n            )\n\n            # Check if operation name is provided\n            if not operation_name or operation_name == \"\":\n                raise Exception(\n                    \"Invalid operation name: Please provide a valid operation name\"\n                )\n\n            # Check if API key is provided\n            if not self.valves.GOOGLE_API_KEY:\n                raise Exception(\n                    \"No Google API key provided. Please set a Google API key in tool valves to use this tool.\"\n                )\n\n            # Make the API request to check status\n            base_url = self.valves.BASE_URL\n            check_url = f\"{base_url}/{operation_name}?key={self.valves.GOOGLE_API_KEY}\"\n\n            response = requests.get(check_url)\n\n            # Check if the request was successful\n            if response.status_code != 200:\n                error_info = response.text\n                raise Exception(\n                    f\"Status check failed with status code: {response.status_code}. Details: {error_info}\"\n                )\n\n            # Parse the response to get the status data\n            status_data = response.json()\n            is_done = status_data.get(\"done\", False)\n\n            if is_done:\n                await emitter.success_update(\"Operation is complete!\")\n                # Check for errors\n                if \"error\" in status_data:\n                    error_details = status_data.get(\"error\", {})\n                    error_message = error_details.get(\"message\", \"Unknown error\")\n                    await emitter.error_update(f\"Operation failed: {error_message}\")\n                    return f\"Error: {error_message}\"\n\n                # Format the response with video URLs in <video> tags using the proxy\n                video_urls = []\n\n                if (\n                    \"response\" in status_data\n                    and \"generateVideoResponse\" in status_data[\"response\"]\n                ):\n                    gen_response = status_data[\"response\"][\"generateVideoResponse\"]\n                    if \"generatedSamples\" in gen_response:\n                        samples = gen_response[\"generatedSamples\"]\n                        for sample in samples:\n                            if \"video\" in sample and \"uri\" in sample[\"video\"]:\n                                uri = sample[\"video\"][\"uri\"]\n                                # Extract video ID and create proxy URL\n                                video_id = self._extract_video_id(uri)\n                                if video_id:\n                                    proxy_url = self._create_proxy_url(\n                                        video_id, self.valves.GOOGLE_API_KEY\n                                    )\n                                    video_urls.append(proxy_url)\n\n                # Create the response text with video tags\n                if video_urls:\n                    # Start with LLM instructions and operation announcement\n                    response_text = f\"Video has been generated for operation: {operation_name}\\n\\nReply with the following video tags, no markdown, just plain text output, every tag and content on new line, so no ```text or ```html allowed:\\n\\n\"\n\n                    # Add each video URL in the requested format\n                    for url in video_urls:\n                        response_text += f\"<video>\\n{url}\\n</video>\\n\"\n\n                    return response_text.strip()\n                else:\n                    return (\n                        \"Operation is complete, but no video URLs found in the response\"\n                    )\n            else:\n                await emitter.progress_update(\"Operation is still in progress\")\n                return (\n                    \"Video generation is still in progress. Please check again later.\"\n                )\n\n        except Exception as e:\n            error_message = f\"Error: {str(e)}\"\n            if \"401\" in str(e) or \"403\" in str(e):\n                error_message += \" (API key issue. Please check your Google API key.)\"\n            await emitter.error_update(error_message)\n            return error_message\n\n\nclass GoogleVeoToolTest(unittest.IsolatedAsyncioTestCase):\n    async def test_extract_video_id(self):\n        tool = Tools()\n        video_id = tool._extract_video_id(\n            \"https://generativelanguage.googleapis.com/v1beta/files/u6e5f8rzq8cn:download?alt=media\"\n        )\n        self.assertEqual(video_id, \"u6e5f8rzq8cn\")\n\n        video_id = tool._extract_video_id(\n            \"https://generativelanguage.googleapis.com/v1beta/files/pbac2s0cpb7a\"\n        )\n        self.assertEqual(video_id, \"pbac2s0cpb7a\")\n\n    async def test_generate_video_with_invalid_input(self):\n        response = await Tools().generate_video(\"\")\n        self.assertTrue(\"Error\" in response)\n\n\nif __name__ == \"__main__\":\n    print(\"Running tests...\")\n    unittest.main()\n","specs":[{"name":"_create_proxy_url","description":"Create a proxy URL for the video using the specified format.","parameters":{"properties":{"video_id":{"type":"string"},"api_key":{"type":"string"}},"required":["video_id","api_key"],"type":"object"}},{"name":"_extract_video_id","description":"Extract the video ID from a Google Veo video URI.","parameters":{"properties":{"uri":{"type":"string"}},"required":["uri"],"type":"object"}},{"name":"check_video_status","description":"Check the status of a video generation operation.","parameters":{"properties":{"operation_name":{"description":"The operation name returned by the generate_video method.","type":"string"}},"required":["operation_name"],"type":"object"}},{"name":"generate_video","description":"Generates a video using Google's Veo API based on a text prompt or image.","parameters":{"properties":{"prompt":{"description":"Text description of the video content you want to generate. Optional if image is provided.","type":"string"},"aspect_ratio":{"default":"16:9","description":"The aspect ratio of the video. Supported values are \"16:9\" and \"9:16\". Default is \"16:9\".","type":"string"},"negative_prompt":{"anyOf":[{"type":"string"},{"type":"null"}],"default":null,"description":"Text string that describes anything you want to discourage the model from generating."},"person_generation":{"default":"allow_adult","description":"Controls generation of people in videos. Options:","type":"string"},"number_of_videos":{"default":1,"description":"Output videos requested, either 1 or 2.","type":"integer"},"duration_seconds":{"default":8,"description":"Length of each output video in seconds, between 5 and 8.","type":"integer"},"enhance_prompt":{"default":true,"description":"Enable or disable the prompt rewriter. Enabled by default.","type":"boolean"},"image":{"anyOf":[{"type":"string"},{"type":"null"}],"default":null,"description":"The image to use as the first frame for the video. Optional if prompt is provided."}},"required":["prompt"],"type":"object"}}],"meta":{"description":"Generate Video","manifest":{}},"access_control":{"read":{"group_ids":[],"user_ids":[]},"write":{"group_ids":[],"user_ids":[]}},"updated_at":1758161440,"created_at":1758160497}]